{% extends "admin/base.html" %}

{% block page_title %}Users{% endblock %}

{% block page_actions %}
{% if current_user.is_admin %}
<a href="{{ url_for('create_user') }}" class="btn btn-primary-modern">
    <i class="fas fa-plus me-2" style="font-size: 12px;"></i>Add User
</a>
{% endif %}
{% endblock %}

{% block page_content %}
<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert" style="border-radius: 6px; border: 1px solid var(--border-primary); background: var(--bg-elevated);">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" style="filter: invert(0.5);"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<!-- Metronic Users Table -->
<div class="card-modern" style="background: var(--bg-elevated); border: 1px solid var(--border-primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
    <div class="card-header-modern" style="background: var(--bg-elevated); border-bottom: 1px solid var(--border-primary); padding: 20px;">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h3 style="margin: 0; color: var(--text-primary); font-size: 18px; font-weight: 600;">User Management</h3>
                <p style="margin: 4px 0 0 0; color: var(--text-secondary); font-size: 14px;">Manage user accounts and permissions</p>
            </div>
            <div class="d-flex align-items-center">
                <span class="badge" style="background: var(--bg-tertiary); color: var(--text-tertiary); padding: 4px 8px; border-radius: 12px; font-size: 12px; border: 1px solid var(--border-primary);">
                    {{ users.total if users else 0 }} users
                </span>
            </div>
        </div>
    </div>
    <div class="card-body-modern" style="padding: 0; background: var(--bg-elevated);">
        <div class="table-responsive">
            <table class="table table-hover" style="margin: 0; font-size: 14px; background: var(--bg-elevated);">
                <thead style="background: var(--bg-tertiary); border-bottom: 1px solid var(--border-primary);">
                    <tr>
                        <th class="d-none d-md-table-cell" style="font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-tertiary); padding: 12px 20px; border: none;">ID</th>
                        <th style="font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-tertiary); padding: 12px 20px; border: none;">User</th>
                        <th class="d-none d-lg-table-cell" style="font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-tertiary); padding: 12px 20px; border: none;">Email</th>
                        <th style="font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-tertiary); padding: 12px 20px; border: none;">Status</th>
                        <th class="d-none d-md-table-cell" style="font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-tertiary); padding: 12px 20px; border: none;">Role</th>
                        <th class="d-none d-lg-table-cell" style="font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-tertiary); padding: 12px 20px; border: none;">Created</th>
                        <th class="d-none d-xl-table-cell" style="font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-tertiary); padding: 12px 20px; border: none;">Last Login</th>
                        <th style="font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-tertiary); padding: 12px 20px; border: none;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if users and users.items %}
                        {% for user in users.items %}
                        <tr style="border-bottom: 1px solid var(--border-primary); transition: all 0.15s ease;">
                            <td class="d-none d-md-table-cell" style="padding: 16px 20px; color: var(--text-secondary); font-weight: 500; border: none;">{{ user.id }}</td>
                            <td style="padding: 16px 20px; border: none;">
                                <div class="d-flex align-items-center">
                                    <div class="rounded-circle" style="width: 32px; height: 32px; background: var(--brand-gradient); display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                        <span style="font-size: 12px; color: white; font-weight: 600;">{{ user.username[0].upper() if user.username else 'U' }}</span>
                                    </div>
                                    <div>
                                        <div style="font-weight: 500; color: var(--text-primary); font-size: 14px; margin-bottom: 2px;">{{ user.full_name or user.username }}</div>
                                        <div style="font-size: 12px; color: var(--text-tertiary);">{{ user.username }}</div>
                                        <!-- Mobile: Show email below name on small screens -->
                                        <div class="d-lg-none" style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">{{ user.email }}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="d-none d-lg-table-cell" style="padding: 16px 20px; color: var(--text-secondary); border: none;">{{ user.email }}</td>
                            <td style="padding: 16px 20px; border: none;">
                                {% if user.is_active %}
                                    <span class="badge" style="background: var(--success); color: white; font-size: 11px; padding: 4px 8px; border-radius: 12px; font-weight: 500;">Active</span>
                                {% else %}
                                    <span class="badge" style="background: var(--error); color: white; font-size: 11px; padding: 4px 8px; border-radius: 12px; font-weight: 500;">Inactive</span>
                                {% endif %}
                                <!-- Mobile: Show role below status on small screens -->
                                <div class="d-md-none" style="margin-top: 4px;">
                                    {% if user.is_admin %}
                                        <span class="badge" style="background: var(--brand-primary); color: white; font-size: 10px; padding: 2px 6px; border-radius: 12px; font-weight: 500;">Admin</span>
                                    {% else %}
                                        <span class="badge" style="background: var(--text-tertiary); color: white; font-size: 10px; padding: 2px 6px; border-radius: 12px; font-weight: 500;">User</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="d-none d-md-table-cell" style="padding: 16px 20px; border: none;">
                                {% if user.is_admin %}
                                    <span class="badge" style="background: var(--brand-primary); color: white; font-size: 11px; padding: 4px 8px; border-radius: 12px; font-weight: 500;">Admin</span>
                                {% else %}
                                    <span class="badge" style="background: var(--text-tertiary); color: white; font-size: 11px; padding: 4px 8px; border-radius: 12px; font-weight: 500;">User</span>
                                {% endif %}
                            </td>
                            <td class="d-none d-lg-table-cell" style="padding: 16px 20px; color: var(--text-secondary); font-size: 13px; border: none;">{{ user.created_at.strftime('%Y-%m-%d') if user.created_at else 'N/A' }}</td>
                            <td class="d-none d-xl-table-cell" style="padding: 16px 20px; color: var(--text-secondary); font-size: 13px; border: none;">{{ user.last_login.strftime('%m/%d %H:%M') if user.last_login else 'Never' }}</td>
                            <td style="padding: 16px 20px; border: none;">
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm" data-bs-toggle="modal" data-bs-target="#viewModal{{ user.id }}" 
                                            style="background: var(--bg-tertiary); border: 1px solid var(--border-primary); color: var(--brand-primary); border-radius: 6px; padding: 6px 8px; transition: all 0.15s ease; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;"
                                            onmouseover="this.style.background='var(--bg-glass-hover)'" onmouseout="this.style.background='var(--bg-tertiary)'">
                                        <i class="fas fa-eye" style="font-size: 12px;"></i>
                                    </button>
                                    {% if current_user.is_admin %}
                                    <a href="{{ url_for('edit_user', user_id=user.id) }}" class="btn btn-sm" 
                                       style="background: var(--bg-tertiary); border: 1px solid var(--border-primary); color: var(--warning); border-radius: 6px; padding: 6px 8px; text-decoration: none; transition: all 0.15s ease; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;"
                                       onmouseover="this.style.background='var(--bg-glass-hover)'" onmouseout="this.style.background='var(--bg-tertiary)'">
                                        <i class="fas fa-edit" style="font-size: 12px;"></i>
                                    </a>
                                    {% if user.id != current_user.id %}
                                    <button class="btn btn-sm" data-bs-toggle="modal" data-bs-target="#deleteModal{{ user.id }}"
                                            style="background: var(--bg-tertiary); border: 1px solid var(--border-primary); color: var(--error); border-radius: 6px; padding: 6px 8px; transition: all 0.15s ease; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;"
                                            onmouseover="this.style.background='var(--bg-glass-hover)'" onmouseout="this.style.background='var(--bg-tertiary)'">
                                        <i class="fas fa-trash" style="font-size: 12px;"></i>
                                    </button>
                                    {% endif %}
                                    {% endif %}
                                </div>
                            </td>
                        </tr>

                        <!-- View Modal -->
                        <div class="modal fade" id="viewModal{{ user.id }}" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content" style="background: var(--bg-elevated); border: 1px solid var(--border-primary); border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.1);">
                                    <div class="modal-header" style="background: var(--bg-elevated); border-bottom: 1px solid var(--border-primary); padding: 20px;">
                                        <h5 class="modal-title" style="color: var(--text-primary); font-weight: 600; font-size: 16px;">User Details</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(0.5);"></button>
                                    </div>
                                    <div class="modal-body" style="padding: 20px; background: var(--bg-elevated);">
                                        <div class="row">
                                            <div class="col-md-4 text-center">
                                                <div class="rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 80px; height: 80px; background: var(--brand-gradient); margin-bottom: 16px;">
                                                    <span style="font-size: 28px; color: white; font-weight: 700;">{{ user.username[0].upper() if user.username else 'U' }}</span>
                                                </div>
                                            </div>
                                            <div class="col-md-8">
                                                <h5 style="color: var(--text-primary); margin-bottom: 8px;">{{ user.full_name or user.username }}</h5>
                                                <p style="color: var(--text-tertiary); margin-bottom: 16px; font-size: 14px;">@{{ user.username }}</p>
                                                <hr style="border-color: var(--border-primary); margin: 16px 0;">
                                                <div class="row g-3">
                                                    <div class="col-sm-6">
                                                        <label style="color: var(--text-tertiary); font-size: 12px; text-transform: uppercase; font-weight: 600;">Email</label>
                                                        <p style="color: var(--text-primary); margin: 4px 0 0 0;">{{ user.email }}</p>
                                                    </div>
                                                    <div class="col-sm-6">
                                                        <label style="color: var(--text-tertiary); font-size: 12px; text-transform: uppercase; font-weight: 600;">Status</label>
                                                        <p style="margin: 4px 0 0 0;">
                                                            {% if user.is_active %}
                                                                <span class="badge" style="background: var(--success); color: white;">Active</span>
                                                            {% else %}
                                                                <span class="badge" style="background: var(--error); color: white;">Inactive</span>
                                                            {% endif %}
                                                        </p>
                                                    </div>
                                                    <div class="col-sm-6">
                                                        <label style="color: var(--text-tertiary); font-size: 12px; text-transform: uppercase; font-weight: 600;">Role</label>
                                                        <p style="margin: 4px 0 0 0;">
                                                            {% if user.is_admin %}
                                                                <span class="badge" style="background: var(--brand-primary); color: white;">Admin</span>
                                                            {% else %}
                                                                <span class="badge" style="background: var(--text-tertiary); color: white;">User</span>
                                                            {% endif %}
                                                        </p>
                                                    </div>
                                                    <div class="col-sm-6">
                                                        <label style="color: var(--text-tertiary); font-size: 12px; text-transform: uppercase; font-weight: 600;">Created</label>
                                                        <p style="color: var(--text-primary); margin: 4px 0 0 0;">{{ user.created_at.strftime('%Y-%m-%d %H:%M') if user.created_at else 'N/A' }}</p>
                                                    </div>
                                                    <div class="col-sm-12">
                                                        <label style="color: var(--text-tertiary); font-size: 12px; text-transform: uppercase; font-weight: 600;">Last Login</label>
                                                        <p style="color: var(--text-primary); margin: 4px 0 0 0;">{{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else 'Never logged in' }}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer" style="background: var(--bg-tertiary); border-top: 1px solid var(--border-primary); padding: 16px 20px;">
                                        <button type="button" class="btn btn-secondary-modern" data-bs-dismiss="modal">Close</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {% if current_user.is_admin and user.id != current_user.id %}
                        <!-- Delete Modal -->
                        <div class="modal fade" id="deleteModal{{ user.id }}" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content" style="background: var(--bg-elevated); border: 1px solid var(--border-primary); border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.1);">
                                    <div class="modal-header" style="background: var(--bg-elevated); border-bottom: 1px solid var(--border-primary); padding: 20px;">
                                        <h5 class="modal-title" style="color: var(--text-primary); font-weight: 600; font-size: 16px;">Delete User</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(0.5);"></button>
                                    </div>
                                    <div class="modal-body" style="padding: 20px; background: var(--bg-elevated);">
                                        <div class="text-center mb-3">
                                            <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: var(--error); margin-bottom: 16px;"></i>
                                        </div>
                                        <p style="color: var(--text-secondary); text-align: center; margin-bottom: 8px;">Are you sure you want to delete user <strong style="color: var(--text-primary);">{{ user.username }}</strong>?</p>
                                        <p style="color: var(--error); text-align: center; font-size: 14px; margin: 0;">This action cannot be undone.</p>
                                    </div>
                                    <div class="modal-footer" style="background: var(--bg-tertiary); border-top: 1px solid var(--border-primary); padding: 16px 20px;">
                                        <button type="button" class="btn btn-secondary-modern" data-bs-dismiss="modal">Cancel</button>
                                        <form method="POST" action="{{ url_for('delete_user', user_id=user.id) }}" style="display: inline;">
                                            <button type="submit" class="btn" style="background: var(--error); color: white; border: none; border-radius: 6px; font-weight: 600; padding: 8px 16px; font-size: 13px;">Delete User</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="8" style="padding: 40px 20px; text-align: center; border: none;">
                                <div style="color: var(--text-tertiary);">
                                    <i class="fas fa-users" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                                    <h5 style="color: var(--text-secondary); margin-bottom: 8px;">No users found</h5>
                                    <p style="font-size: 14px; margin: 0;">Users will appear here once they are created.</p>
                                </div>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <!-- Metronic Pagination -->
        {% if users and users.pages > 1 %}
        <div style="padding: 20px; border-top: 1px solid var(--border-primary); background: var(--bg-tertiary);">
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center" style="margin: 0;">
                    {% if users.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('users', page=users.prev_num) }}" 
                               style="border: 1px solid var(--border-primary); border-radius: 6px; color: var(--text-primary); margin-right: 4px; padding: 8px 12px; background: var(--bg-elevated); font-size: 13px; transition: all 0.15s ease;"
                               onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='var(--bg-elevated)'">Previous</a>
                        </li>
                    {% endif %}
                    
                    {% for page_num in users.iter_pages() %}
                        {% if page_num %}
                            {% if page_num != users.page %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('users', page=page_num) }}" 
                                       style="border: 1px solid var(--border-primary); border-radius: 6px; color: var(--text-primary); margin-right: 4px; padding: 8px 12px; transition: all 0.15s ease; background: var(--bg-elevated); font-size: 13px; min-width: 36px; text-align: center;"
                                       onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='var(--bg-elevated)'">{{ page_num }}</a>
                                </li>
                            {% else %}
                                <li class="page-item active">
                                    <span class="page-link" style="background: var(--brand-primary); border: none; border-radius: 6px; color: white; margin-right: 4px; padding: 8px 12px; box-shadow: 0 2px 4px rgba(0, 158, 247, 0.3); font-size: 13px; min-width: 36px; text-align: center;">{{ page_num }}</span>
                                </li>
                            {% endif %}
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link" style="border: 1px solid var(--border-primary); border-radius: 6px; color: var(--text-tertiary); margin-right: 4px; padding: 8px 12px; background: var(--bg-elevated); font-size: 13px;">...</span>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if users.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('users', page=users.next_num) }}" 
                               style="border: 1px solid var(--border-primary); border-radius: 6px; color: var(--text-primary); margin-right: 4px; padding: 8px 12px; background: var(--bg-elevated); font-size: 13px; transition: all 0.15s ease;"
                               onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='var(--bg-elevated)'">Next</a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<style>
    /* Metronic Table Hover Effects */
    .table-hover tbody tr:hover {
        background-color: var(--bg-tertiary) !important;
    }
    
    /* Professional button hover effects */
    .btn:hover {
        transform: translateY(-1px);
    }
    
    /* Modal enhancements */
    .modal-content {
        border: none;
    }
    
    /* Badge consistency */
    .badge {
        font-weight: 500;
        letter-spacing: 0.5px;
    }
</style>
{% endblock %}

{% block scripts %}
<!-- DataTables Enhancement -->
<script>
    // Enhanced table interactions
    document.addEventListener('DOMContentLoaded', function() {
        // Add smooth hover effects to action buttons
        const actionButtons = document.querySelectorAll('.btn[data-bs-toggle]');
        actionButtons.forEach(button => {
            button.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-1px)';
                this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
            });
            button.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
            });
        });
    });
</script>
{% endblock %}